<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Banca Escuela — Simulador educativo</title>
  <style>
    :root{
      --bg:#f4f6fb;
      --card:#ffffff;
      --text:#0f172a;
      --muted:#64748b;
      --primary:#1e40af;
      --primary-2:#1d4ed8;
      --danger:#dc2626;
      --ok:#16a34a;
      --shadow: 0 16px 34px rgba(2,6,23,.10);
      --radius: 22px;

      --cta-h: 74px; /* altura barra CTA fija */
    }
    *{box-sizing:border-box}
    html{ font-size:16px; }
    html.big{ font-size:19px; }
    html.hc{
      --bg:#ffffff;
      --card:#ffffff;
      --text:#000000;
      --muted:#1f2937;
      --primary:#000000;
      --primary-2:#000000;
      --shadow: 0 0 0 rgba(0,0,0,0);
    }

    body{
      margin:0;
      font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial;
      background: linear-gradient(180deg, #fff, var(--bg));
      color:var(--text);
    }

    .app{
      max-width: 420px;
      margin: 0 auto;
      min-height: 100vh;
      display:flex;
      flex-direction:column;
      background: var(--bg);
    }

    .status{
      padding: 12px 16px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      background:#fff;
      border-bottom: 1px solid rgba(2,6,23,.06);
      position: sticky;
      top:0;
      z-index: 30;
    }

    .pill{
      font-size: 0.78rem;
      padding: 7px 10px;
      border-radius: 999px;
      background:#fff7ed;
      border: 1px solid rgba(234,88,12,.18);
      color:#9a3412;
      font-weight:900;
      display:flex;
      gap:8px;
      align-items:center;
    }

    .topbar{
      padding: 12px 16px 14px;
      display:flex;
      align-items:center;
      justify-content:space-between;
      background:#fff;
      border-bottom: 1px solid rgba(2,6,23,.06);
      position: sticky;
      top: 54px; /* debajo status */
      z-index: 25;
    }

    .brand{
      display:flex;
      flex-direction:column;
      gap:2px;
    }
    .brand .name{font-weight:900}
    .brand .sub{font-size:0.78rem;color:var(--muted);font-weight:700}

    .content{
      flex:1;
      padding: 16px;
      padding-bottom: 92px; /* navbar inferior */
    }

    .banner{
      background:#fff7ed;
      border: 1px solid rgba(234,88,12,.20);
      color:#9a3412;
      padding: 12px 12px;
      border-radius: 14px;
      font-size: 0.85rem;
      line-height: 1.25rem;
      margin-bottom: 12px;
    }

    .card{
      background:var(--card);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      padding: 18px;
      margin-bottom: 14px;
      border: 1px solid rgba(2,6,23,.05);
    }

    h1,h2,h3{margin:0 0 8px}
    h1{font-size:1.55rem}
    h2{font-size:1.15rem}
    h3{font-size:1.02rem}
    p{margin:0 0 10px;color:var(--muted);line-height:1.35rem}
    .small{font-size:0.8rem;color:var(--muted);font-weight:700}

    .btn{
      width:100%;
      border:0;
      border-radius: 999px;
      padding: 18px 18px;
      font-weight: 900;
      font-size: 1.05rem;
      cursor:pointer;
      background: var(--primary);
      color:#fff;
      box-shadow: 0 12px 22px rgba(2,6,23,.14);
      transition: transform .05s ease, filter .15s ease, box-shadow .15s ease;
    }
    .btn:hover{ filter: brightness(1.02); }
    .btn:active{
      transform: translateY(1px);
      box-shadow: 0 7px 14px rgba(2,6,23,.12);
    }
    .btn.secondary{
      background:#fff;
      color: var(--primary);
      border: 1px solid rgba(30, 64, 175, .18);
      box-shadow: 0 12px 22px rgba(2,6,23,.06);
    }
    .btn.ghost{
      background: transparent;
      color: var(--primary);
      border:1px dashed rgba(30,64,175,.35);
      box-shadow:none;
    }
    .btn.small{
      width:auto;
      padding: 10px 14px;
      font-size: 0.9rem;
      border-radius: 999px;
      box-shadow:none;
    }

    .row{display:flex; gap:10px}
    .row .btn{flex:1}

    .link{
      color:var(--primary-2);
      font-weight:900;
      text-decoration:none;
      cursor:pointer;
      display:inline-block;
      margin-top:6px;
    }

    .divider{height:1px;background:rgba(2,6,23,.08);margin:10px 0}

    .field{
      display:flex;
      flex-direction:column;
      gap:6px;
      margin-bottom: 12px;
    }
    label{font-size:0.82rem;color:var(--muted);font-weight:900}
    input, select{
      width:100%;
      padding: 13px 12px;
      border-radius: 14px;
      border:1px solid rgba(2,6,23,.12);
      outline:none;
      font-size:1rem;
      background:#fff;
    }
    input:focus, select:focus{border-color: rgba(30,64,175,.55)}

    /* PIN */
    .pin{
      display:flex;
      gap:10px;
      justify-content:center;
      margin: 12px 0 8px;
    }
    .pin input{
      width:64px;
      text-align:center;
      font-size:1.4rem;
      font-weight: 900;
      padding: 14px 10px;
    }

    /* Segmentado tipo banca */
    .segment{
      display:flex;
      gap:12px;
      margin-top: 14px;
    }
    .segbtn{
      flex:1;
      border-radius: 999px;
      padding: 13px 12px;
      font-weight: 900;
      border: 1px solid rgba(2,6,23,.10);
      background:#fff;
      color: var(--primary);
      cursor:pointer;
    }
    .segbtn.active{
      background: var(--primary);
      color:#fff;
      border-color: transparent;
      box-shadow: 0 12px 22px rgba(2,6,23,.12);
    }

    /* Tarjeta cuenta */
    .account-card{ padding: 20px; }
    .amt{
      font-weight: 950;
      font-size: 2.1rem;
      letter-spacing: -0.8px;
    }
    .account-meta{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-top: 6px;
    }

    /* Lista */
    .list{display:flex;flex-direction:column;gap:10px}
    .item{
      display:flex;align-items:flex-start;justify-content:space-between;gap:10px;
      padding: 12px;
      border-radius: 16px;
      border:1px solid rgba(2,6,23,.08);
      background:#fff;
    }
    .item .title{font-weight:950}
    .item .meta{font-size:0.82rem;color:var(--muted);line-height:1.1rem;font-weight:800}
    .badge{
      font-size:0.78rem;
      padding:6px 10px;
      border-radius: 999px;
      background:#eef2ff;
      color:#3730a3;
      font-weight:950;
      white-space:nowrap;
      border: 1px solid rgba(55,48,163,.12);
    }
    .amt.pos{color:var(--ok)}
    .amt.neg{color:var(--danger)}

    /* Navbar inferior */
    .nav{
      position: fixed;
      left:50%;
      transform: translateX(-50%);
      bottom: 0;
      width: min(420px, 100%);
      background:#fff;
      border-top: 1px solid rgba(2,6,23,.08);
      display:flex;
      justify-content:space-around;
      padding: 10px 8px;
      z-index: 40;
    }
    .nav button{
      border:0;background:transparent;cursor:pointer;
      font-weight:950;color:var(--muted);
      display:flex;flex-direction:column;gap:4px;align-items:center;
      font-size:0.78rem;
      padding: 8px 10px;
      border-radius: 14px;
    }
    .nav button.active{color:var(--primary)}
    .hidden{display:none}

    /* Paso x de y */
    .stepper{
      display:flex;
      align-items:center;
      justify-content:space-between;
      gap:10px;
      margin-bottom: 10px;
    }
    .stepper .step{
      font-weight:950;
      font-size:0.9rem;
    }
    .progress{
      flex:1;
      height:8px;
      background: rgba(2,6,23,.08);
      border-radius: 999px;
      overflow:hidden;
    }
    .bar{
      height:100%;
      width:0%;
      background: var(--primary);
    }

    /* CTA fijo (botón abajo) */
    .cta{
      position: fixed;
      left:50%;
      transform: translateX(-50%);
      bottom: 62px; /* encima del nav */
      width: min(420px, 100%);
      padding: 10px 12px;
      z-index: 45;
      pointer-events:none; /* permite scroll detrás salvo dentro */
    }
    .cta-inner{
      pointer-events:auto;
      background:#fff;
      border: 1px solid rgba(2,6,23,.08);
      border-radius: 18px;
      padding: 10px;
      box-shadow: 0 16px 34px rgba(2,6,23,.12);
    }
    .cta-row{
      display:flex;
      gap:10px;
      align-items:center;
    }
    .cta-row .btn{ box-shadow:none; padding: 16px 16px; }
    .cta-row .btn.secondary{ box-shadow:none; }

    /* Bottom sheet */
    .overlay{
      position: fixed;
      inset: 0;
      background: rgba(2,6,23,.45);
      display:none;
      z-index: 60;
    }
    .sheet{
      position: fixed;
      left:50%;
      transform: translateX(-50%);
      bottom: -520px;
      width: min(420px, 100%);
      background:#fff;
      border-radius: 22px 22px 0 0;
      border: 1px solid rgba(2,6,23,.10);
      box-shadow: 0 -18px 40px rgba(2,6,23,.20);
      padding: 14px 16px 18px;
      z-index: 70;
      transition: bottom .22s ease;
    }
    .sheet.open{ bottom: 0; }
    .overlay.open{ display:block; }
    .grab{
      width: 44px;
      height: 5px;
      border-radius: 999px;
      background: rgba(2,6,23,.20);
      margin: 6px auto 12px;
    }
    .sheet-title{
      font-weight: 950;
      font-size: 1.15rem;
      margin-bottom: 8px;
    }
    .sheet .item{
      border-radius: 18px;
      padding: 14px;
    }
    .sheet .item .title{ font-size: 1rem; }
  </style>
</head>

<body>
  <div class="app">
    <div class="status">
      <div class="pill">Modo práctica · Simulador educativo</div>
      <div class="small" id="clock"></div>
    </div>

    <div class="topbar">
      <div class="brand">
        <div class="name">Banca Escuela</div>
        <div class="sub">Aplicación de aprendizaje (no oficial)</div>
      </div>
      <div class="small" id="userChip"></div>
    </div>

    <div class="content" id="view"></div>

    <div class="nav hidden" id="nav">
      <button data-nav="home" id="navHome">Inicio</button>
      <button data-nav="transfer" id="navTransfer">Transferir</button>
      <button data-nav="security" id="navSecurity">Seguridad</button>
      <button data-nav="more" id="navMore">Más</button>
    </div>
  </div>

  <!-- CTA fijo -->
  <div class="cta hidden" id="cta">
    <div class="cta-inner">
      <div class="cta-row" id="ctaRow"></div>
    </div>
  </div>

  <!-- Bottom sheet Transferir -->
  <div class="overlay" id="overlay"></div>
  <div class="sheet" id="sheet">
    <div class="grab"></div>
    <div class="sheet-title">Transferir</div>
    <div class="small" style="margin-bottom:12px;">Selecciona una opción (modo práctica).</div>

    <div class="list">
      <div class="item" id="sheetThird">
        <div>
          <div class="title">A terceros</div>
          <div class="meta">Transferir a una persona o cuenta guardada</div>
        </div>
        <span class="badge">Opción</span>
      </div>

      <div class="item" id="sheetBetween">
        <div>
          <div class="title">Entre mis cuentas</div>
          <div class="meta">Mover dinero entre cuentas del simulador</div>
        </div>
        <span class="badge">Opción</span>
      </div>

      <button class="btn secondary" id="sheetClose" style="margin-top:8px;">Cerrar</button>
    </div>
  </div>

<script>
/* =========================
   Estado (simulación local)
   ========================= */
const state = {
  acceptedDisclaimer: false,
  userName: "Perfil de práctica",
  authed: false,
  pin: "1234",
  accessibility: {
    bigText: false,
    highContrast: false,
  },
  activeTab: "guardados",
  accounts: [
    { id:"acc1", name:"Cuenta Principal", number:"00023160749", balance: 2225 },
    { id:"acc2", name:"Cuenta Pro", number:"37870206438", balance: 0 },
  ],
  transactions: [
    { date:"viernes, 12 de diciembre de 2025", desc:"Pago de ejemplo", amount:-3300 },
    { date:"viernes, 5 de diciembre de 2025", desc:"Pago de ejemplo", amount:-12200 },
    { date:"viernes, 5 de diciembre de 2025", desc:"Transferencia recibida (simulada)", amount:6100 },
    { date:"viernes, 5 de diciembre de 2025", desc:"Transferencia enviada (simulada)", amount:-4350 },
    { date:"viernes, 5 de diciembre de 2025", desc:"Transferencia enviada (simulada)", amount:-1945 },
  ],
  recipients: [
    { id:"r1", name:"Alejandra Leal", bank:"Banco Demo", account:"Cuenta Demo 14598034", alias:"" },
    { id:"r2", name:"Alejandra Olivares Valdés", bank:"Banco Demo", account:"Cuenta Demo 9708677", alias:"Mamá" },
    { id:"r3", name:"Ana María Salgado Vargas", bank:"Banco Demo", account:"Cuenta Demo 65148250", alias:"Anita" },
    { id:"r4", name:"Flavio Emilio González", bank:"Banco Demo", account:"Cuenta Demo 0017597579", alias:"" },
  ],
  selectedRecipientId: "r4",
  transferDraft: {
    fromAccountId: "acc2",
    amount: "",
    message: "",
    saveRecipient: "no",
    alias: ""
  }
};

const $view = document.getElementById("view");
const $nav = document.getElementById("nav");
const $userChip = document.getElementById("userChip");
const $cta = document.getElementById("cta");
const $ctaRow = document.getElementById("ctaRow");

/* ======================
   Utilidades
   ====================== */
function moneyCLP(n){
  const sign = n < 0 ? "-" : "";
  const abs = Math.abs(n);
  return sign + "$" + abs.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ".");
}
function escapeHtml(s){
  return String(s ?? "").replace(/[&<>"']/g, (c)=>({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"
  }[c]));
}
function groupBy(arr, fn){
  return arr.reduce((acc, item)=>{
    const k = fn(item);
    (acc[k] ||= []).push(item);
    return acc;
  }, {});
}

/* ======================
   Accesibilidad
   ====================== */
function applyAccessibility(){
  document.documentElement.classList.toggle("big", !!state.accessibility.bigText);
  document.documentElement.classList.toggle("hc", !!state.accessibility.highContrast);
}

/* ======================
   Router
   ====================== */
let currentRoute = "disclaimer";
function go(route){
  currentRoute = route;
  render();
}

function setActiveNav(key){
  for (const id of ["navHome","navTransfer","navSecurity","navMore"]) {
    document.getElementById(id).classList.remove("active");
  }
  if (key === "home") document.getElementById("navHome").classList.add("active");
  if (key === "transfer") document.getElementById("navTransfer").classList.add("active");
  if (key === "security") document.getElementById("navSecurity").classList.add("active");
  if (key === "more") document.getElementById("navMore").classList.add("active");
}

function setCTA(buttons){
  if (!buttons || buttons.length === 0){
    $cta.classList.add("hidden");
    $ctaRow.innerHTML = "";
    return;
  }
  $cta.classList.remove("hidden");
  $ctaRow.innerHTML = buttons.map(b => {
    const cls = b.kind === "secondary" ? "btn secondary" : "btn";
    return `<button class="${cls}" id="${b.id}">${escapeHtml(b.label)}</button>`;
  }).join("");
  // wire
  buttons.forEach(b=>{
    document.getElementById(b.id).onclick = b.onClick;
  });
}

function render(){
  applyAccessibility();

  $userChip.textContent = state.authed ? state.userName : "";
  $nav.style.display = state.authed ? "flex" : "none";

  // Oculta CTA por defecto; cada vista lo activa si corresponde
  setCTA([]);

  if (!state.acceptedDisclaimer) return renderDisclaimer();

  // No autenticado: permitir login y pin
  if (!state.authed) {
    if (currentRoute === "pin") return renderPin();
    return renderLogin();
  }

  switch(currentRoute){
    case "home": return renderHome();
    case "movements": return renderMovements();
    case "recipients": return renderRecipients();         // Paso 1 de 3
    case "new-recipient": return renderNewRecipient();    // Paso 1 de 3 (variante)
    case "transfer-form": return renderTransferForm();    // Paso 2 de 3
    case "transfer-confirm": return renderTransferConfirm(); // Paso 3 de 3
    case "security": return renderSecurity();
    case "more": return renderMore();
    default: return renderHome();
  }
}

/* ======================
   Vistas
   ====================== */
function renderDisclaimer(){
  $view.innerHTML = `
    <div class="banner">
      <b>Importante:</b> Esta aplicación es un simulador educativo. No pertenece a ningún banco y no realiza operaciones reales.
      No ingreses datos bancarios reales.
    </div>

    <div class="card">
      <h1>Simulador de banca</h1>
      <p>Aprende paso a paso: revisar saldo, ver movimientos y simular transferencias.</p>
      <div class="divider"></div>
      <button class="btn" id="accept">Entiendo y continuar</button>
      <button class="btn secondary" id="exit" style="margin-top:10px;">Salir</button>
    </div>
  `;
  document.getElementById("accept").onclick = () => {
    state.acceptedDisclaimer = true;
    go("login");
  };
  document.getElementById("exit").onclick = () => {
    $view.innerHTML = `<div class="card"><h2>Sesión finalizada</h2><p>Puedes cerrar esta pestaña.</p></div>`;
  };
}

function renderLogin(){
  $view.innerHTML = `
    <div class="banner">
      <b>Modo práctica:</b> simulador educativo. No es una aplicación oficial.
    </div>

    <div class="card">
      <h1 style="margin-bottom:6px;">Hola</h1>
      <div style="font-weight:950;font-size:1.2rem;margin-bottom:6px;">${escapeHtml(state.userName)}</div>
      <p class="small">Acceso de demostración para aprender la mecánica de una app bancaria.</p>

      <div style="height:12px;"></div>

      <button class="btn" id="enter">Ingresar al simulador</button>

      <div style="text-align:center;margin-top:10px;">
        <a class="link" id="about">¿Qué es este simulador?</a>
      </div>
    </div>

    <div class="card hidden" id="aboutCard">
      <h2>¿Qué es?</h2>
      <p>Todo es ficticio (saldos, movimientos y transferencias). No ingreses datos reales.</p>
      <button class="btn secondary" id="closeAbout">Cerrar</button>
    </div>
  `;
  document.getElementById("enter").onclick = () => go("pin");
  document.getElementById("about").onclick = () => document.getElementById("aboutCard").classList.toggle("hidden");
  document.getElementById("closeAbout").onclick = () => document.getElementById("aboutCard").classList.add("hidden");
}

function renderPin(){
  $view.innerHTML = `
    <div class="banner"><b>Modo práctica:</b> Usa una clave inventada. Ejemplo para clase: <b>1234</b>.</div>

    <div class="card">
      <h2>Ingresa tu clave de práctica</h2>
      <p>Ingresa 4 dígitos.</p>

      <div class="pin">
        <input inputmode="numeric" maxlength="1" id="p1" aria-label="dígito 1">
        <input inputmode="numeric" maxlength="1" id="p2" aria-label="dígito 2">
        <input inputmode="numeric" maxlength="1" id="p3" aria-label="dígito 3">
        <input inputmode="numeric" maxlength="1" id="p4" aria-label="dígito 4">
      </div>

      <button class="btn" id="pinOk">Aceptar</button>

      <div style="text-align:center;">
        <a class="link" id="pinHelp">¿Problemas con tu clave?</a>
      </div>
      <p class="small hidden" id="pinMsg" style="margin-top:8px;"></p>
    </div>
  `;

  const inputs = ["p1","p2","p3","p4"].map(id => document.getElementById(id));
  inputs[0].focus();

  inputs.forEach((inp, idx) => {
    inp.addEventListener("input", () => {
      inp.value = (inp.value || "").replace(/\D/g,"").slice(0,1);
      if (inp.value && idx < inputs.length-1) inputs[idx+1].focus();
    });
    inp.addEventListener("keydown", (e) => {
      if (e.key === "Backspace" && !inp.value && idx>0) inputs[idx-1].focus();
    });
  });

  document.getElementById("pinHelp").onclick = () => {
    const msg = document.getElementById("pinMsg");
    msg.classList.remove("hidden");
    msg.style.color = "";
    msg.textContent = "En modo práctica puedes usar 1234 (PIN de ejemplo).";
  };

  document.getElementById("pinOk").onclick = () => {
    const entered = inputs.map(i=>i.value).join("");
    if (entered.length !== 4) return showPinError("Ingresa los 4 dígitos.");
    if (entered !== state.pin) return showPinError("Clave incorrecta (modo práctica). Prueba 1234.");

    state.authed = true;
    go("home");
  };

  function showPinError(text){
    const msg = document.getElementById("pinMsg");
    msg.classList.remove("hidden");
    msg.style.color = "#b91c1c";
    msg.textContent = text;
  }
}

function renderHome(){
  setActiveNav("home");

  const mainAcc = state.accounts[0];
  $view.innerHTML = `
    <div class="banner"><b>Recordatorio:</b> simulador educativo. No hay dinero real ni operaciones reales.</div>

    <div class="card account-card">
      <h2 style="margin-bottom:4px;">${escapeHtml(mainAcc.name)}</h2>

      <div class="account-meta">
        <div class="small">N° ${escapeHtml(mainAcc.number)}</div>
        <div class="small">Saldo disponible</div>
      </div>

      <div style="margin-top:8px;">
        <div class="amt">${moneyCLP(mainAcc.balance)}</div>
      </div>

      <div class="segment">
        <button class="segbtn active" id="goMov">Movimientos</button>
        <button class="segbtn" id="goDocs">Documentos</button>
      </div>
    </div>

    <div class="card">
      <h2>Accesos rápidos</h2>
      <div class="row" style="margin-top:10px;">
        <button class="btn secondary" id="quickTransfer">Transferir</button>
        <button class="btn secondary" id="quickRecipients">Destinatarios</button>
      </div>
      <p class="small" style="margin-top:10px;">Sugerencia: revisa movimientos y luego simula una transferencia.</p>
    </div>
  `;

  document.getElementById("goMov").onclick = () => go("movements");
  document.getElementById("goDocs").onclick = () => alert("Documentos (simulado): aquí podrías mostrar PDFs de ejemplo.");
  document.getElementById("quickTransfer").onclick = () => openSheet(); // bottom sheet
  document.getElementById("quickRecipients").onclick = () => go("recipients");
}

function renderMovements(){
  setActiveNav("home");

  const groups = groupBy(state.transactions, t => t.date);
  const htmlGroups = Object.entries(groups).map(([date, items]) => {
    const li = items.map(t => `
      <div class="item">
        <div>
          <div class="title">${escapeHtml(t.desc)}</div>
          <div class="meta">${escapeHtml(date)}</div>
        </div>
        <div class="amt ${t.amount>=0 ? "pos":"neg"}" style="font-size:1.1rem;">${moneyCLP(t.amount)}</div>
      </div>
    `).join("");
    return `<h3 style="margin:16px 0 8px;">${escapeHtml(date)}</h3><div class="list">${li}</div>`;
  }).join("");

  $view.innerHTML = `
    <div class="card">
      <h2>Saldos y movimientos</h2>
      <p class="small">Ejemplo de movimientos ficticios.</p>
      <button class="btn secondary" id="backHome">Volver a Inicio</button>
    </div>
    ${htmlGroups}
  `;
  document.getElementById("backHome").onclick = () => go("home");
}

/* Paso 1 de 3 */
function renderRecipients(){
  setActiveNav("transfer");
  const filtered = state.recipients;

  $view.innerHTML = `
    <div class="card">
      ${stepperHTML(1,3)}
      <h2>¿A quién quieres transferir?</h2>
      <p class="small">Selecciona un destinatario o agrega uno nuevo.</p>

      <div class="row" style="margin-top:10px;">
        <button class="btn secondary" id="newR">Nuevo destinatario</button>
        <button class="btn secondary" id="myAcc">Entre mis cuentas</button>
      </div>

      <div class="field" style="margin-top:12px;">
        <label>Buscar por nombre o alias</label>
        <input id="q" placeholder="Ej: Mamá, Anita..." />
      </div>

      <div class="divider"></div>
      <div class="small">Destinatarios</div>
    </div>

    <div class="list" id="recList">
      ${renderRecipientList(filtered)}
    </div>
  `;

  setCTA([
    { id:"ctaBack", label:"Volver", kind:"secondary", onClick: ()=> go("home") }
  ]);

  document.getElementById("newR").onclick = () => go("new-recipient");
  document.getElementById("myAcc").onclick = () => alert("Entre mis cuentas (simulado): puedes implementar este flujo luego.");

  function wirePickButtons(){
    document.querySelectorAll("[data-pick]").forEach(b=>{
      b.onclick = () => {
        state.selectedRecipientId = b.dataset.pick;
        state.transferDraft.amount = "";
        state.transferDraft.message = "";
        state.transferDraft.saveRecipient = "no";
        state.transferDraft.alias = "";
        go("transfer-form");
      };
    });
  }

  wirePickButtons();

  const q = document.getElementById("q");
  q.addEventListener("input", () => {
    const term = q.value.trim().toLowerCase();
    const res = state.recipients.filter(r => {
      const hay = `${r.name} ${r.alias} ${r.bank} ${r.account}`.toLowerCase();
      return hay.includes(term);
    });
    document.getElementById("recList").innerHTML = renderRecipientList(res);
    wirePickButtons();
  });
}

function renderRecipientList(list){
  if (!list || list.length === 0){
    return `<div class="card"><p>No hay resultados.</p></div>`;
  }
  return list.map(r => `
    <div class="item">
      <div>
        <div class="title">${escapeHtml(r.alias ? `${r.alias} — ${r.name}` : r.name)}</div>
        <div class="meta">${escapeHtml(r.bank)} · ${escapeHtml(r.account)}</div>
      </div>
      <button class="btn secondary small" data-pick="${r.id}">Elegir</button>
    </div>
  `).join("");
}

/* Paso 1 de 3 (agregar destinatario) */
function renderNewRecipient(){
  setActiveNav("transfer");
  $view.innerHTML = `
    <div class="card">
      ${stepperHTML(1,3)}
      <h2>Nuevo destinatario</h2>
      <p>Ingresa un identificador de práctica. Ejemplo: 12.345.678-9 (solo demostración).</p>

      <div class="field">
        <label>Documento / ID (práctica)</label>
        <input id="doc" placeholder="Ej: 12.345.678-9" />
      </div>

      <p class="small" id="msg" style="margin-top:6px;color:#b91c1c;"></p>
    </div>
  `;

  setCTA([
    { id:"ctaBack", label:"Volver", kind:"secondary", onClick: ()=> go("recipients") },
    { id:"ctaContinue", label:"Continuar", kind:"primary", onClick: ()=>{
        const v = document.getElementById("doc").value.trim();
        if (!v) return (document.getElementById("msg").textContent = "Ingresa un ID para continuar.");

        const id = "r" + (state.recipients.length + 1);
        state.recipients.unshift({
          id,
          name: "Destinatario de práctica",
          bank: "Banco Demo",
          account: `Cuenta Demo ${Math.floor(10000000 + Math.random()*90000000)}`,
          alias: ""
        });
        state.selectedRecipientId = id;
        go("transfer-form");
      }
    }
  ]);
}

/* Paso 2 de 3 */
function renderTransferForm(){
  setActiveNav("transfer");
  const rec = state.recipients.find(r=>r.id===state.selectedRecipientId);
  const accOptions = state.accounts.map(a => `
    <option value="${a.id}" ${a.id===state.transferDraft.fromAccountId ? "selected":""}>
      ${escapeHtml(a.name)} (${moneyCLP(a.balance)})
    </option>
  `).join("");

  $view.innerHTML = `
    <div class="banner"><b>Simulación:</b> al confirmar no se enviará dinero real.</div>

    <div class="card">
      ${stepperHTML(2,3)}
      <h2>Transferir</h2>

      <div class="field">
        <label>Cuenta de origen</label>
        <select id="from">${accOptions}</select>
      </div>

      <div class="item" style="border-radius:18px;">
        <div>
          <div class="title">${escapeHtml(rec.alias ? `${rec.alias} — ${rec.name}` : rec.name)}</div>
          <div class="meta">${escapeHtml(rec.bank)} · ${escapeHtml(rec.account)}</div>
        </div>
        <span class="badge">Destinatario</span>
      </div>

      <div class="field" style="margin-top:12px;">
        <label>Ingresa un monto (simulado)</label>
        <input id="amount" inputmode="numeric" placeholder="Ej: 5000" value="${escapeHtml(state.transferDraft.amount)}" />
      </div>

      <div class="field">
        <label>Incluir mensaje (opcional)</label>
        <input id="msg" placeholder="Ej: Almuerzo" value="${escapeHtml(state.transferDraft.message)}" maxlength="50" />
        <div class="small">Máximo 50 caracteres</div>
      </div>

      <div class="field">
        <label>¿Guardar este destinatario?</label>
        <select id="save">
          <option value="si" ${state.transferDraft.saveRecipient==="si"?"selected":""}>Sí</option>
          <option value="no" ${state.transferDraft.saveRecipient==="no"?"selected":""}>No</option>
        </select>
      </div>

      <div class="field">
        <label>Alias (opcional)</label>
        <input id="alias" placeholder="Ej: Vecina" value="${escapeHtml(state.transferDraft.alias)}" maxlength="25" />
      </div>

      <p class="small" id="err" style="margin-top:6px;color:#b91c1c;"></p>
    </div>
  `;

  document.getElementById("from").onchange = (e) => state.transferDraft.fromAccountId = e.target.value;
  document.getElementById("amount").oninput = (e) => {
    e.target.value = e.target.value.replace(/\D/g,"").slice(0,10);
    state.transferDraft.amount = e.target.value;
  };
  document.getElementById("msg").oninput = (e) => state.transferDraft.message = e.target.value.slice(0,50);
  document.getElementById("save").onchange = (e) => state.transferDraft.saveRecipient = e.target.value;
  document.getElementById("alias").oninput = (e) => state.transferDraft.alias = e.target.value.slice(0,25);

  setCTA([
    { id:"ctaBack", label:"Volver", kind:"secondary", onClick: ()=> go("recipients") },
    { id:"ctaContinue", label:"Continuar", kind:"primary", onClick: ()=>{
        const err = document.getElementById("err");
        err.textContent = "";
        const amt = parseInt(state.transferDraft.amount || "0", 10);
        if (!amt || amt <= 0) return (err.textContent = "Ingresa un monto válido.");
        go("transfer-confirm");
      }
    }
  ]);
}

/* Paso 3 de 3 */
function renderTransferConfirm(){
  setActiveNav("transfer");

  const rec = state.recipients.find(r=>r.id===state.selectedRecipientId);
  const acc = state.accounts.find(a=>a.id===state.transferDraft.fromAccountId);
  const amt = parseInt(state.transferDraft.amount,10);

  $view.innerHTML = `
    <div class="card">
      ${stepperHTML(3,3)}
      <h2>Confirmar simulación</h2>
      <p class="small">Revisa los datos. Esto no realiza una transferencia real.</p>

      <div class="divider"></div>

      <div class="item">
        <div>
          <div class="title">Desde</div>
          <div class="meta">${escapeHtml(acc.name)} · Saldo ${moneyCLP(acc.balance)}</div>
        </div>
        <span class="badge">Cuenta</span>
      </div>

      <div class="item">
        <div>
          <div class="title">Hacia</div>
          <div class="meta">${escapeHtml(rec.name)} · ${escapeHtml(rec.bank)}</div>
        </div>
        <span class="badge">Destinatario</span>
      </div>

      <div class="item">
        <div>
          <div class="title">Monto</div>
          <div class="meta">Monto simulado</div>
        </div>
        <div class="amt" style="font-size:1.4rem;">${moneyCLP(amt)}</div>
      </div>

      ${state.transferDraft.message ? `
        <div class="item">
          <div>
            <div class="title">Mensaje</div>
            <div class="meta">${escapeHtml(state.transferDraft.message)}</div>
          </div>
          <span class="badge">Opcional</span>
        </div>
      ` : ""}

      <div class="divider"></div>
      <p class="small">Al confirmar, se agregará un movimiento ficticio para fines pedagógicos.</p>
    </div>
  `;

  setCTA([
    { id:"ctaEdit", label:"Editar", kind:"secondary", onClick: ()=> go("transfer-form") },
    { id:"ctaConfirm", label:"Confirmar", kind:"primary", onClick: ()=>{
        // Guardar alias si corresponde (simulado)
        if (state.transferDraft.saveRecipient === "si" && state.transferDraft.alias.trim()) {
          rec.alias = state.transferDraft.alias.trim();
        }

        // Registrar movimiento ficticio
        state.transactions.unshift({
          date: "hoy (simulado)",
          desc: `Transferencia simulada a ${rec.alias ? rec.alias : rec.name}`,
          amount: -amt
        });

        // Descontar saldo en simulación (opcional)
        acc.balance = Math.max(0, acc.balance - amt);

        // Resultado
        setCTA([]);
        $view.innerHTML = `
          <div class="banner"><b>Listo:</b> se completó una simulación. No hubo transferencia real.</div>
          <div class="card">
            <h2>Simulación confirmada</h2>
            <p>Se agregó un movimiento ficticio para que puedas revisarlo en “Movimientos”.</p>
          </div>
        `;
        setCTA([
          { id:"ctaMov", label:"Ver movimientos", kind:"primary", onClick: ()=> go("movements") },
          { id:"ctaHome", label:"Ir a Inicio", kind:"secondary", onClick: ()=> go("home") },
        ]);
      }
    }
  ]);
}

function renderSecurity(){
  setActiveNav("security");
  $view.innerHTML = `
    <div class="card">
      <h2>Seguridad (práctica)</h2>
      <p>Sección para enseñar conceptos como PIN, cuidado con estafas, y confirmación de operaciones.</p>
      <div class="divider"></div>
      <button class="btn secondary" id="logout">Cerrar sesión (simulada)</button>
    </div>

    <div class="card">
      <h3>Consejo para la clase</h3>
      <p class="small">Repetir siempre: “No compartas tu clave” y “verifica el destinatario antes de confirmar”.</p>
    </div>
  `;
  document.getElementById("logout").onclick = () => {
    state.authed = false;
    closeSheet();
    go("login");
  };
}

function renderMore(){
  setActiveNav("more");
  $view.innerHTML = `
    <div class="card">
      <h2>Más</h2>
      <p class="small">Ajustes pensados para personas mayores.</p>

      <div class="divider"></div>

      <div class="item" style="align-items:center;">
        <div>
          <div class="title">Modo letra grande</div>
          <div class="meta">Aumenta el tamaño de texto y controles</div>
        </div>
        <button class="btn secondary small" id="toggleBig">${state.accessibility.bigText ? "Activado" : "Desactivado"}</button>
      </div>

      <div class="item" style="align-items:center;">
        <div>
          <div class="title">Alto contraste</div>
          <div class="meta">Mejora la legibilidad en pantallas difíciles</div>
        </div>
        <button class="btn secondary small" id="toggleHC">${state.accessibility.highContrast ? "Activado" : "Desactivado"}</button>
      </div>

      <div class="divider"></div>

      <div class="row">
        <button class="btn secondary" id="help">Ayuda</button>
        <button class="btn secondary" id="reset">Reiniciar simulación</button>
      </div>
    </div>

    <div class="card">
      <h3>Modo docente (idea)</h3>
      <p class="small">Puedes añadir escenarios: saldo bajo, destinatario incorrecto, confirmación doble, etc.</p>
    </div>
  `;

  document.getElementById("toggleBig").onclick = () => {
    state.accessibility.bigText = !state.accessibility.bigText;
    render();
  };
  document.getElementById("toggleHC").onclick = () => {
    state.accessibility.highContrast = !state.accessibility.highContrast;
    render();
  };
  document.getElementById("help").onclick = () => alert(
    "Ayuda (simulador): Todo es ficticio. Practica: Transferir > elegir destinatario > ingresar monto > confirmar."
  );
  document.getElementById("reset").onclick = () => location.reload();
}

/* Stepper */
function stepperHTML(step, total){
  const pct = Math.round((step/total)*100);
  return `
    <div class="stepper">
      <div class="step">Paso ${step} de ${total}</div>
      <div class="progress" aria-label="progreso">
        <div class="bar" style="width:${pct}%"></div>
      </div>
    </div>
  `;
}

/* ======================
   Navbar inferior
   ====================== */
document.querySelectorAll(".nav button").forEach(btn=>{
  btn.addEventListener("click", () => {
    const key = btn.dataset.nav;
    if (key === "home") go("home");
    if (key === "transfer") openSheet();
    if (key === "security") go("security");
    if (key === "more") go("more");
  });
});

/* ======================
   Bottom sheet Transferir
   ====================== */
const $overlay = document.getElementById("overlay");
const $sheet = document.getElementById("sheet");

function openSheet(){
  if (!state.authed) return;
  setActiveNav("transfer");
  $overlay.classList.add("open");
  $sheet.classList.add("open");
}

function closeSheet(){
  $sheet.classList.remove("open");
  $overlay.classList.remove("open");
}

$overlay.addEventListener("click", closeSheet);
document.getElementById("sheetClose").onclick = closeSheet;

document.getElementById("sheetThird").onclick = () => {
  closeSheet();
  go("recipients");
};
document.getElementById("sheetBetween").onclick = () => {
  closeSheet();
  alert("Entre mis cuentas (simulado): puedes implementarlo como segundo flujo.");
};

/* ======================
   Reloj
   ====================== */
function tickClock(){
  const d = new Date();
  const hh = String(d.getHours()).padStart(2,"0");
  const mm = String(d.getMinutes()).padStart(2,"0");
  document.getElementById("clock").textContent = `${hh}:${mm}`;
}
setInterval(tickClock, 1000);
tickClock();

/* Arranque */
go("disclaimer");
</script>
</body>
</html>
